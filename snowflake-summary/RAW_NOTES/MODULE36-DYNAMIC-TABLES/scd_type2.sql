CREATE DATABASE DEMO_DB;

CREATE OR REPLACE TABLE DEMO_DB.PUBLIC.CUSTOMER_CHANGES (
  CUSTOMER_ID INT,
  FIRST_NAME VARCHAR(50),
  LAST_NAME VARCHAR(50),
  EMAIL VARCHAR(100),
  PHONE_NUMBER VARCHAR(15),
  FULL_ADDRESS VARCHAR(365),
  UPDATE_TIME TIMESTAMP_NTZ(9)
);


SELECT TO_TIMESTAMP_NTZ('2013-04-05 01:02:03');
TRUNCATE TABLE CUSTOMER_CHANGES

INSERT INTO CUSTOMER_CHANGES
VALUES
(1, 'John', 'Doe', 'john.doe@example.com', '1234567890', '123 Main St, New York, NY, 10001', TO_TIMESTAMP_NTZ('2023-05-05 01:02:03')),
(2, 'Jane', 'Smith', 'jane.smith@example.com', '0987654321', '456 Pine St, San Francisco, CA, 94101', TO_TIMESTAMP_NTZ('2023-05-05 02:02:03')),
(1, 'John', 'Doe', 'john.doe2@example.com', '1234567890', '789 Broadway St, New York, NY, 10002', TO_TIMESTAMP_NTZ('2023-05-05 03:02:03')),
(3, 'Jim', 'Brown', 'jim.brown@example.com', '1122334455', '321 Elm St, Chicago, IL, 60601', TO_TIMESTAMP_NTZ('2023-05-05 04:02:03')),
(2, 'Jane', 'Smith', 'jane.smith2@example.com', '0987654322', '654 Oak St, San Francisco, CA, 94102', TO_TIMESTAMP_NTZ('2023-05-05 05:02:03'));

select * from demo_db.public.CUSTOMER_CHANGES where customer_id=1



CREATE OR REPLACE DYNAMIC TABLE CUSTOMER_HISTORY
  TARGET_LAG='1 MINUTE'
  WAREHOUSE=COMPUTE_WH
AS
SELECT * RENAME (UPDATE_TIME AS RECORD_START_TIME),
  CUSTOMER_ID || '-' || DATE_PART(EPOCH_MILLISECONDS, UPDATE_TIME) AS CUSTOMER_HISTORY_SK,
  SPLIT_PART(FULL_ADDRESS, ' ', -1) AS POSTAL_CODE,
  LEAD(UPDATE_TIME) OVER (PARTITION BY CUSTOMER_ID ORDER BY UPDATE_TIME ASC) AS RECORD_END_TIME
FROM CUSTOMER_CHANGES;

SELECT * FROM CUSTOMER_HISTORY where customer_id=1

ALTER DYNAMIC TABLE CUSTOMER_HISTORY REFRESH;

INSERT INTO CUSTOMER_CHANGES
VALUES
(1, 'John', 'Doe', 'Gohn.doe@example.com', '1234567890', '123 Main St, New York, CY, 10001', TO_TIMESTAMP_NTZ('2023-05-05 07:02:03'))

SELECT * FROM CUSTOMER_CHANGES

UPDATE CUSTOMER_CHANGES 
SET EMAIL='Gohn.doe@example.com'
WHERE CUSTOMER_ID=1

